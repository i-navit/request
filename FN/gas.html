<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex,nofollow">
    <link rel="icon" href="https://i-navit.github.io/request/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <title>ルミナスゲームズ@Fortnite ルール説明</title>

    <style>
        * {
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            font-family: sans-serif;
            text-align: left;
            color: #333333;
            font-size: 18px;
            background-image: url('img/star.jpg');
            background-repeat: repeat;
            background-attachment: fixed;
        }

        .header-img {
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            height: auto;
            display: block;
        }

        #wrapper {
            max-width: 1000px;
            margin: 0 auto;
            min-height: 100vh;
            height: auto;
            background-color: rgba(255, 255, 255, 0.0);
        }

        .hello {
            background-color: #0f3e69;
            color: #F4F4F9;
            text-align: center;
        }

        /* 左上タイトル付きボックス */
        .cstm-box-title-topleft {
            --box-color: #16b5dd;
            margin: 2em auto;
            position: relative;
            border: 1px solid var(--box-color);
            border-radius: 6px;
            max-width: 87%;
        }

        .cstm-box-title-topleft .box-title {
            background: var(--box-color);
            color: #fff;
            padding: 0.2em 1em;
            position: absolute;
            top: -0.7em;
            left: 0.7em;
            display: inline-block;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 6px;
            max-width: calc(100% - 2em);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cstm-box-title-topleft .box-title i {
            margin-right: 5px;
        }

        .cstm-box-title-topleft .box-content {
            background-color: rgba(238, 254, 255, 0.8);
            padding: 1.7em 1em 1em 1em;
            border-radius: 5px;
        }

        .footer {
            color: #ffffff;
            font-size: 14px;
            padding-bottom: 20px;
            text-align: center;
        }


        /* ------------------------------------------- */
        /* スマートフォン向け調整 (画面幅600px以下に適用) */
        /* ------------------------------------------- */
        @media screen and (max-width: 600px) {

            .cstm-box-title-topleft .box-content {
                font-size: 0.8em;
                padding: 1.7em 1em 0.7em 1em;
            }

            .cstm-box-title-topleft .box-title {
                font-size: 0.9em;
                padding: 0.2em 0.5em;
            }



        }
    </style>

</head>

<body>
    <img class="header-img" src="img/banner_pc.png" alt="luminous ルミナスゲームズ">
    <div id="wrapper">


        <!-- コンテンツを動的に挿入するためのコンテナ -->
        <div id="content-container">
            <!-- スプレッドシートから読み込んだデータがここに表示されます -->
            <p class="text-center p-4 text-gray-500" id="loading-message" style="text-align: center; padding: 20px;">
                データを読み込み中...
            </p>
        </div>




        <div class="footer">©2025 Luminous Games. All Rights Reserved.</div>
    </div>

    <script>
        // ----------------------------------------------------------------------
        // 【重要】Google Apps ScriptのウェブアプリURLをここに設定
        // ユーザーが提供したデプロイ済みURLを設定
        // ----------------------------------------------------------------------
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyV8BxhsvWHJG3rDRGkAgegr9JO-wi0GX46FdKva-6ZFoNp5VZSnXNpVKDCoCS_3C-ITA/exec';

        // エラーを回避するため、使用しないFirebase関連の環境変数の定義を削除しました。

        // Exponential backoff for API retries
        const MAX_RETRIES = 5;
        const INITIAL_DELAY = 1000;

        /**
         * fetch処理をリトライ付きで行う
         * @param {string} url - フェッチするURL
         * @returns {Promise<Response>}
         */
        async function fetchWithRetry(url) {
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        return response;
                    }
                    // 4xx, 5xxなどのエラーレスポンスの場合、リトライを試みる
                    // ただし、今回はGASからの成功応答が期待されるため、ステータスコードエラーは後続のcatchで処理
                    throw new Error(`HTTP Error status: ${response.status}`);
                } catch (error) {
                    if (i === MAX_RETRIES - 1) {
                        throw error; // 最終リトライで失敗
                    }
                    // 指数バックオフによる待機
                    const delay = INITIAL_DELAY * Math.pow(2, i) + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        /**
         * データを取得し、HTMLを生成してDOMに挿入する関数
         */
        async function loadDataAndRender() {
            const container = document.getElementById('content-container');
            const loadingMessage = document.getElementById('loading-message');

            if (!GAS_WEB_APP_URL || !GAS_WEB_APP_URL.startsWith('https://script.google.com/macros/s/')) {
                if (loadingMessage) {
                    loadingMessage.textContent = 'エラー: GASウェブアプリのURLが正しくありません。';
                    loadingMessage.style.color = 'red';
                }
                return;
            }

            try {
                // GASのエンドポイントからデータを取得 (リトライ処理を含む)
                const response = await fetchWithRetry(GAS_WEB_APP_URL);
                const data = await response.json();

                // エラーチェック
                if (data.error) {
                    throw new Error(`GASエラー: ${data.error}`);
                }

                // 読み込みメッセージを削除
                if (loadingMessage) {
                    loadingMessage.remove();
                }

                let allHtml = '';

                // 取得したデータ（シートごと）をループ処理
                data.forEach(item => {
                    // contentの改行文字 (\n) をHTMLの <br> タグに変換
                    // GAS側で空行を \n\n (連続する改行) で表現しているため、<br><br> に変換することで段落間のスペースを表現する
                    // NOTE: pタグ内で <br><br> が連続するとHTMLとして不適切だが、見た目の段落空けとして採用
                    const formattedContent = item.content
                        .replace(/\t/g, ' ') // タブをスペースに変換
                        .replace(/\n\n/g, '<br><br>') // 連続する改行を空白行として扱う
                        .replace(/\n/g, '<br>');      // その他の改行をBRタグに変換

                    // ユーザーが指定した構造を持つHTMLブロックを生成
                    const blockHtml = `
                        <div class="cstm-box-title-topleft">
                            <div class="box-title">${item.title}</div>
                            <div class="box-content">
                                <p>${formattedContent}</p>
                            </div>
                        </div>
                    `;
                    allHtml += blockHtml;
                });

                // 生成したすべてのHTMLをコンテナに挿入
                container.innerHTML = allHtml;

            } catch (error) {
                console.error('データ取得またはレンダリング中にエラーが発生しました:', error);

                // エラー表示用のHTMLを生成
                const errorHtml = `
                    <div class="cstm-box-title-topleft" style="--box-color: #ff4444;">
                        <div class="box-title">エラー発生</div>
                        <div class="box-content">
                            <p>データを読み込めませんでした。<br>
                            - GASウェブアプリが正しくデプロイされ、アクセス権限（公開設定）が「全員」になっているか確認してください。<br>
                            - スプレッドシートID（${'1FDl-W8D9FReH9Ms6eSMBG7Sucup_FdZ0TcJwbGQwqGo'}）が正しいか確認してください。<br>
                            </p>
                            <p style="font-size: 0.8em; color: #ff4444; word-break: break-all;">詳細: ${error.message}</p>
                        </div>
                    </div>
                `;

                // エラーメッセージがあれば、それを置き換える
                if (loadingMessage) {
                    loadingMessage.remove();
                }
                container.innerHTML = errorHtml;
            }
        }

        // ページ読み込み完了後にデータ取得・レンダリングを実行
        window.onload = loadDataAndRender;
    </script>

</body>

</html>