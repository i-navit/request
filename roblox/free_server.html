<!DOCTYPE html>
<html lang="ja">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox ç„¡æ–™ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ¼ãƒãƒ¼ãƒªã‚¹ãƒˆ</title>
    <style>
        /* ========================================================= */
        /* PC/ãƒ¢ãƒã‚¤ãƒ«å…±é€šã®ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        /* ========================================================= */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #def5fc;
            color: #333;
            font-size: 17px; /* ãƒ™ãƒ¼ã‚¹ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’èª¿æ•´ */
        }
        h1 {
            color: #3395ff; 
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.5em; /* ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚µã‚¤ã‚ºã‚’å°‘ã—å¤§ãã */
        }
 
        .header-img {
            width: 90%;
            max-width: 800px;
            height: auto;
            display: block;
            margin: 0 auto;
            margin-bottom: 1rem;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-radius: 0 0 10px 10px;
        }

        .r_link {
          text-decoration: none !important;
          color: #ffa500 !important; 
          }

        /* ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆå…¨ä½“ã‚’ä¸­å¤®ã«é…ç½® (PCå¯¾å¿œ) */
        #map-list { 
            width: 90%;
            max-width: 800px; /* ãƒ†ãƒ¼ãƒ–ãƒ«å¹…ã‚’800pxã«å¤‰æ›´ */
            margin: 0 auto;
            padding: 0;
            display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤ºï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒå®Œäº†ã—ã¦ã‹ã‚‰è¡¨ç¤ºã™ã‚‹ï¼‰ */
        }

        /* å„ã‚²ãƒ¼ãƒ ã‚’ã‚«ãƒ¼ãƒ‰å½¢å¼ã§è¡¨ç¤º */
        .map-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            font-size: 1em; /* ãƒ™ãƒ¼ã‚¹ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‹ã‚‰ã®ç›¸å¯¾ã‚µã‚¤ã‚º */
        }

        /* 1è¡Œç›®: æƒ…å ±ã‚¨ãƒªã‚¢ */
        .info-row {
            padding-bottom: 10px;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd; 
        }
        
        /* ãƒãƒƒãƒ—ã‚¿ã‚¤ãƒˆãƒ« */
        .card-title {
            font-size: 1.1em; /* ãƒ™ãƒ¼ã‚¹ã‚ˆã‚Šå°‘ã—å¤§ãã */
            font-weight: bold;
            color: #3395ff; 
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #3395ff; 
        }

        /* çµ±åˆã•ã‚ŒãŸè©³ç´°æƒ…å ±ã®å˜ä¸€è¡Œã‚³ãƒ³ãƒ†ãƒŠ */
        .map-details {
            font-size: 0.9em; /* å°‘ã—å°ã•ãã—ã¦æƒ…å ±ã‚’è¦‹ã‚„ã™ã */
            color: #444;
            white-space: normal; 
            margin-top: 5px;
            line-height: 1.5;
        }
        /* ãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        .map-details a {
            font-weight: normal; 
            text-decoration: underline; 
            color: #1a73e8; /* ãƒªãƒ³ã‚¯è‰²ã‚’æ˜ç¢ºã« */
        }

        /* .mobile-newline ã¯ä¸è¦ã«ãªã£ãŸãŸã‚å‰Šé™¤ */


        /* 2è¡Œç›®: è©•ä¾¡ã‚¨ãƒªã‚¢ */
        .reaction-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* è©•ä¾¡ãƒ©ãƒ™ãƒ« (å·¦å´) */
        .reaction-label {
            font-weight: bold;
            color: #555;
            flex-basis: 150px; 
            min-width: 90px;
        }
        /* ãƒœã‚¿ãƒ³ã¨ã‚«ã‚¦ãƒ³ãƒˆã®ã‚³ãƒ³ãƒ†ãƒŠ (å³å´) */
        .reaction-buttons-container {
            text-align: right;
            flex-grow: 1;
            white-space: nowrap;
        }


        /* è©•ä¾¡ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .reaction-btn {
            color: white;
            border: none;
            padding: 5px 10px; 
            margin-right: 5px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        /* â—¯ ãƒœã‚¿ãƒ³ã®è‰²è¨­å®š (ãƒ”ãƒ³ã‚¯) */
        .reaction-btn[data-reaction="circle"] {
            background-color: #ff69b4; 
        }
        /* â–³ ãƒœã‚¿ãƒ³ã®è‰²è¨­å®š (ã‚ªãƒ¬ãƒ³ã‚¸) */
        .reaction-btn[data-reaction="triangle"] {
            background-color: #ffa500; 
        }
        /* âœ• ãƒœã‚¿ãƒ³ã®è‰²è¨­å®š (é’) */
        .reaction-btn[data-reaction="cross"] {
            background-color: #007bff; 
        }

        /* ãƒ›ãƒãƒ¼æ™‚ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .reaction-btn:hover {
            opacity: 0.8;
        }

        /* æ›´æ–°ä¸­ã®ãƒœã‚¿ãƒ³ã‚’è¦–è¦šçš„ã«åŒºåˆ¥ã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ« */
        .reaction-btn[data-status="updating"] {
            opacity: 0.5;
            cursor: wait;
        }

        .count-span {
            font-weight: bold;
            margin-left: 5px;
            color: #e30613; 
        }


        /* ========================================================= */
        /* â˜…ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        /* ========================================================= */
        #loading-overlay {
            display: block; /* åˆæœŸçŠ¶æ…‹ã¯è¡¨ç¤º */
            text-align: center;
            padding: 50px 0;
            font-size: 1.1em;
            color: #666;
            width: 90%;
            max-width: 800px; /* ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã¨åŒã˜å¹…ã«è¨­å®š */
            margin: 0 auto;
        }
        /* ã‚¹ãƒ”ãƒŠãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3395ff; /* ç·‘ã®ã‚¹ãƒ”ãƒŠãƒ¼ */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========================================================= */
        /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ç”¨èª¿æ•´ (ç”»é¢å¹…ãŒ600pxä»¥ä¸‹ã®å ´åˆã«é©ç”¨) */
        /* ========================================================= */
        @media (max-width: 600px) {
            
            #map-list {
                max-width: none;
            }
            .map-card {
                font-size: 1em;
            }
            .reaction-label {
                flex-basis: 90px;
            }
            .reaction-btn {
                padding: 4px 8px;
            }
            .count-span {
                margin-left: 0;
            }

            /* â˜…ä¿®æ­£ç‚¹ï¼šãƒ¢ãƒã‚¤ãƒ«ã§ã®ã¿ãƒªãƒ³ã‚¯ã‚’ãƒ–ãƒ­ãƒƒã‚¯è¦ç´ ã«ã—ã¦å¼·åˆ¶çš„ã«æ”¹è¡Œã•ã›ã‚‹ */
            .map-details a {
                display: block;
                /* ä¸Šã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã®éš™é–“ã‚’ä½œã‚‹ */
                margin-top: 5px; 
            }
        }
    </style>
</head>
<body>

    <img class="header-img" src="https://i-navit.github.io/request/roblox/img/free_server.png" alt="ã¼ã£ã¡ã‚“ã‚¬ã‚¤ãƒ‰â˜…ãƒ«ãƒŸãƒŠã‚¹ã‚²ãƒ¼ãƒ ã‚º">

    <!-- â˜…ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p>
    </div>

    <div id="map-list">
        <!-- ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialCounts();
        });

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’æ“ä½œã™ã‚‹é–¢æ•°
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'block';
            document.getElementById('map-list').style.display = 'none';
        }
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤ºã‚’æ“ä½œã™ã‚‹é–¢æ•°
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('map-list').style.display = 'block';
        }

        function loadInitialCounts() {
            showLoading(); // èª­ã¿è¾¼ã¿é–‹å§‹æ™‚ã«è¡¨ç¤º
            google.script.run
                .withSuccessHandler(displayCounts)
                .withFailureHandler(onLoadFailure)
                .getCounts();
        }

        // PC/ã‚¹ãƒãƒ›å…±é€šã§ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
        function displayCounts(mapList) {
            hideLoading(); // èª­ã¿è¾¼ã¿æˆåŠŸæ™‚ã«éè¡¨ç¤º

            const mapListContainer = document.getElementById('map-list');
            let htmlContent = '';

            mapList.forEach(data => {
                const mapUrl = data.url;
                
                const maxPlayers = data.maxPlayers || '-';
                const genre = data.genre || '-';
                const subGenre = data.subGenre || '-';
                const linkText = `<a href="${mapUrl}" target="_blank" class="r_link">ğŸ”—Robloxã§é–‹ã</a>`;
                
                // æƒ…å ±é …ç›®ã‚’çµ±åˆã—ã¦å˜ä¸€è¡Œã®HTMLã‚’ç”Ÿæˆ
                const detailsHtml = `
                    <div class="map-details">
                        æœ€å¤§äººæ•°: ${maxPlayers}äººã€€
                        ã‚¸ãƒ£ãƒ³ãƒ«: ${genre}ã€€
                        ã‚µãƒ–ã‚¸ãƒ£ãƒ³ãƒ«: ${subGenre}ã€€
                        ${linkText}
                    </div>
                `;

                // ã‚«ãƒ¼ãƒ‰ã®HTMLã‚’ç”Ÿæˆ (2è¡Œæ§‹æˆ)
                htmlContent += `
                    <div class="map-card" data-url="${mapUrl}">
                        
                        <!-- 1è¡Œç›®: ãƒãƒƒãƒ—æƒ…å ± -->
                        <div class="info-row">
                            <div class="card-title">${data.title}</div>
                            
                            ${detailsHtml} <!-- çµ±åˆã•ã‚ŒãŸæƒ…å ±è¡Œã‚’æŒ¿å…¥ -->
                        </div>

                        <!-- 2è¡Œç›®: è©•ä¾¡ã‚¨ãƒªã‚¢ -->
                        <div class="reaction-row">
                            <span class="reaction-label">è©•ä¾¡</span>
                            <div class="reaction-buttons-container">
                                <button class="reaction-btn" data-reaction="circle" data-status="ready">â—¯</button>
                                <span class="count-span" data-reaction="circle">${data.circle}</span>
                                <button class="reaction-btn" data-reaction="triangle" data-status="ready">â–³</button>
                                <span class="count-span" data-reaction="triangle">${data.triangle}</span>
                                <button class="reaction-btn" data-reaction="cross" data-status="ready">âœ•</button>
                                <span class="count-span" data-reaction="cross">${data.cross}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            mapListContainer.innerHTML = htmlContent;

            attachEventListeners();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function attachEventListeners() {
            const buttons = document.querySelectorAll('.reaction-btn');
            
            buttons.forEach(button => {
                button.addEventListener('click', (event) => {
                    const button = event.target;
                    const reactionType = button.getAttribute('data-reaction');
                    
                    // ã™ã§ã«æ›´æ–°å‡¦ç†ä¸­ã®å ´åˆã¯ç„¡è¦–
                    if (button.getAttribute('data-status') === 'updating') {
                        return;
                    }

                    const container = button.closest('.map-card');
                    const gameUrl = container ? container.getAttribute('data-url') : null;
                    
                    if (!gameUrl) {
                        console.error('ã‚¨ãƒ©ãƒ¼: ã‚²ãƒ¼ãƒ ã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                        return;
                    }
                    
                    // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ä¸­ã«å¤‰æ›´ï¼ˆè¦–è¦šçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ã¿ï¼‰
                    button.setAttribute('data-status', 'updating'); 

                    google.script.run
                        .withSuccessHandler(onUpdateSuccess.bind(null, button)) 
                        .withFailureHandler(onUpdateFailure.bind(null, button)) 
                        .updateCount(gameUrl, reactionType);
                });
            });
        }
        
        // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°æˆåŠŸæ™‚ã®å‡¦ç† (ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®æ­£ç¢ºãªå€¤ã§æ›´æ–°)
        function onUpdateSuccess(button, result) {
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å…ƒã«æˆ»ã™
            button.setAttribute('data-status', 'ready');

            if (result.success) {
                const url = result.mapUrl;
                
                // è©²å½“ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’å…¨ã¦æ›´æ–° (ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®æ­£ç¢ºãªå€¤ã§ä¸Šæ›¸ã)
                const cards = document.querySelectorAll(`.map-card[data-url="${url}"]`);
                cards.forEach(card => {
                    card.querySelector(`.count-span[data-reaction="circle"]`).textContent = result.circle;
                    card.querySelector(`.count-span[data-reaction="triangle"]`).textContent = result.triangle;
                    card.querySelector(`.count-span[data-reaction="cross"]`).textContent = result.cross;
                });

            } else {
                console.error('è©•ä¾¡ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ:', result.error);
            }
        }
        
        // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°å¤±æ•—æ™‚ã®å‡¦ç† (ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æˆ»ã™ã®ã¿)
        function onUpdateFailure(button, error) { 
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å…ƒã«æˆ»ã™
            button.setAttribute('data-status', 'ready');
            
            console.error('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç½®ã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', error);
        }

        function onLoadFailure(error) {
            hideLoading(); // èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã‚‚éè¡¨ç¤º
            console.error('åˆæœŸãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        }
    </script>

</body>
</html>
