<!DOCTYPE html>
<html>
<head>
<title>定型文ワンクリックコピー（スプレッドシート連携版）</title>
<style>
  body {
    font-family: sans-serif;
    padding: 5px 20px;
    text-align: left;
    background-color: #fff;
    color: #3e3e3e;
  }

  .container {
    width: 100%;
    margin-bottom: 15px;
  }

  .copyTarget {
    padding: 5px 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    background-color: #f9f9f9;
    width: 100%;
    box-sizing: border-box;
    text-align: left;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out;
  }

  .copyTarget:hover {
    background-color: yellow;
  }

  .message {
    display: none;
    margin-top: 5px;
    color: #ff0099;
  }

  .white{
    color: #fff;
  }
  .red{
    color: #ff0000;
  }

.customkey_ttl {
	background: #a78acb;
	color: #fff;
	font-weight: bold;
	padding: 0.5em 1em 0.2em;
	display: inline-block;
	margin-bottom: 0;
	border-radius: 5px 5px 0 0;
	}
.customkey_box {
	border-radius: 0 5px 5px 5px;
	background: #e0e0ff;
	padding: 1em;
	}
</style>
</head>
<body>

<div class="customkey_ttl">カスタムキーを入力してね</div>
<div class="customkey_box">
<input type="text" id="customKeyInput" name="customkey" onkeyup="updateCustomKey()">
<div class="container">
  <p class="copyTarget" id="customKeyCopyTarget">カスタムキー🔑★</p>
  <p class="message">コピー完了！</p>
</div>
</div>

<div id="spreadsheetTexts">
  </div>

<script>
// ①カスタムキーの即時反映と保存
const customKeyInput = document.getElementById('customKeyInput');
const customKeyCopyTarget = document.getElementById('customKeyCopyTarget');

function updateCustomKey() {
  const customKeyValue = customKeyInput.value;
  customKeyCopyTarget.innerText = `カスタムキー🔑${customKeyValue}★`;
}

// ページ読み込み時にカスタムキーをスプレッドシートから取得して反映
google.script.run.withSuccessHandler(function(customKey) {
  if (customKey) {
    customKeyInput.value = customKey;
    updateCustomKey();
  }
}).getCustomKey();


// ②スプレッドシートから文章を読み込んで表示
google.script.run.withSuccessHandler(function(data) {
  const spreadsheetTextsDiv = document.getElementById('spreadsheetTexts');
  data.forEach(function(text) {
    if (text) { // 空のセルは表示しない
      const containerDiv = document.createElement('div');
      containerDiv.className = 'container';

      const pCopyTarget = document.createElement('p');
      pCopyTarget.className = 'copyTarget';
      pCopyTarget.innerText = text;

      const pMessage = document.createElement('p');
      pMessage.className = 'message';
      pMessage.innerText = 'コピー完了！';

      containerDiv.appendChild(pCopyTarget);
      containerDiv.appendChild(pMessage);
      spreadsheetTextsDiv.appendChild(containerDiv);
    }
  });
  // DOMContentLoadedの代わりにここでコピー機能を再設定
  setupCopyFunctionality();
}).getSpreadsheetData();

// コピー機能の汎用化
function setupCopyFunctionality() {
  const copyTargets = document.querySelectorAll('.copyTarget');
  const messages = document.querySelectorAll('.message');

  copyTargets.forEach((target, index) => {
    target.addEventListener('click', function() {
      const textToCopy = this.innerText;
      const messageElement = messages[index]; // 対応するメッセージ要素を取得

      // カスタムキーの場合、カスタムキーだけをコピーするように調整
      if (this.id === 'customKeyCopyTarget') {
        const customKeyValue = customKeyInput.value;
        navigator.clipboard.writeText(customKeyValue)
          .then(() => {
            messageElement.style.display = "block";
            setTimeout(function() {
              messageElement.style.display = "none";
            }, 1000);
            // カスタムキーをスプレッドシートに保存
            google.script.run.saveCustomKey(customKeyValue);
          })
          .catch(err => {
            console.error('クリップボードへの書き込みに失敗しました:', err);
            messageElement.textContent = "コピーに失敗しました。";
            messageElement.style.color = "red";
            messageElement.style.display = "block";
            setTimeout(function() {
              messageElement.style.display = "none";
              messageElement.textContent = "コピー完了！";
              messageElement.style.color = "#ff0099"; // 元の色に戻す
            }, 3000);
          });
      } else {
        // それ以外の定型文
        navigator.clipboard.writeText(textToCopy)
          .then(() => {
            messageElement.style.display = "block";
            setTimeout(function() {
              messageElement.style.display = "none";
            }, 1000);
          })
          .catch(err => {
            console.error('クリップボードへの書き込みに失敗しました:', err);
            messageElement.textContent = "コピーに失敗しました。";
            messageElement.style.color = "red";
            messageElement.style.display = "block";
            setTimeout(function() {
              messageElement.style.display = "none";
              messageElement.textContent = "コピー完了！";
              messageElement.style.color = "#ff0099"; // 元の色に戻す
            }, 3000);
          });
      }
    });
  });
}

// 初期ロード時にもコピー機能を有効にする
// DOMContentLoadedで実行すると、GASからのデータ取得前に実行される可能性があるため、
// `getSpreadsheetData()` の `withSuccessHandler` 内で `setupCopyFunctionality()` を呼び出すように変更。

</script>

</body>
</html>
